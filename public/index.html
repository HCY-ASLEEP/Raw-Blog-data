<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hcy-asleep.github.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"remove","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="A Space Belongs To HCY">
<meta property="og:type" content="website">
<meta property="og:title" content="A Coder&#39;s Pocket">
<meta property="og:url" content="https://hcy-asleep.github.com/index.html">
<meta property="og:site_name" content="A Coder&#39;s Pocket">
<meta property="og:description" content="A Space Belongs To HCY">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HCY">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hcy-asleep.github.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>A Coder's Pocket</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">A Coder's Pocket</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Just For Fun</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/HCY-ASLEEP" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/06/MySQL-%E9%97%B2%E8%B0%88-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/06/MySQL-%E9%97%B2%E8%B0%88-3/" class="post-title-link" itemprop="url">MySQL 闲谈 3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-06 16:20:23 / Modified: 16:56:20" itemprop="dateCreated datePublished" datetime="2022-11-06T16:20:23+08:00">2022-11-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
要不你来讲讲你们对MySQL是怎么调优的？
</div></div></div>

<h6 id=""><a href="#" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
哇，这命题很大阿…我认为，对于开发者而言，对MySQL的调优重点一般是在「开发规范」、「数据库索引」又或者说解决线上慢查询上
</div></div></div>

<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而对于MySQL内部的参数调优，由专业的DBA来搞
</div></div></div>

<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
扯了这么多，你就是想表达你不会MySQL参数调优，对吧
</div></div></div>

<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
草，被发现了
</div></div></div>

<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那你来聊聊你们平时开发的规范和索引这块，平时是怎么样的吧
</div></div></div>


<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，首先，我们在生产环境下，创建数据库表，都是在工单系统下完成的（那就自然需要DBA审批）。如果在创建表时检测到没有创建索引，那就会直接提示warning（：
</div></div></div>

<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-adf9da0a7ab5845f85b8e487095f71ae_r.jpg"/>
</div></div></div>

<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
理论上来说，如果表有一定的数据量，那就应该要创建对应的索引。从数据库查询数据需要注意的地方还是蛮多的，其中很多都是平时积累来的。比如说：
</div></div></div>

<h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
1. 是否能使用「覆盖索引」，减少「回表」所消耗的时间。意味着，我们在select 的时候，一定要指明对应的列，而不是select *
</div></div></div>

<h6 id="-9"><a href="#-9" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
2. 考虑是否组建「联合索引」，如果组建「联合索引」，尽量将区分度最高的放在最左边，并且需要考虑「最左匹配原则」
</div></div></div>

<h6 id="-10"><a href="#-10" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
3.对索引进行函数操作或者表达式计算会导致索引失效
</div></div></div>

<h6 id="-11"><a href="#-11" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
4.利用子查询优化超多分页场景。比如 limit offset , n 在MySQL是获取 offset + n的记录，再返回n条。而利用子查询则是查出n条，通过ID检索对应的记录出来，提高查询效率
</div></div></div>

<h6 id="-12"><a href="#-12" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯…
</div></div></div>

<h6 id="-13"><a href="#-13" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
5.通过explain命令来查看SQL的执行计划，看看自己写的SQL是否走了索引，走了什么索引。通过show profile 来查看SQL对系统资源的损耗情况（不过一般还是比较少用到的）
</div></div></div>

<h6 id="-14"><a href="#-14" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
6.在开启事务后，在事务内尽可能只操作数据库，并有意识地减少锁的持有时间（比如在事务内需要插入&&修改数据，那可以先插入后修改。因为修改是更新操作，会加行锁。如果先更新，那并发下可能会导致多个事务的请求等待行锁释放）
</div></div></div>

<h6 id="-15"><a href="#-15" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-482ac758e3b5d1bb5e52407e52f44fb1_r.jpg"/>
</div></div></div>

<h6 id="-16"><a href="#-16" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，你提到了事务，之前也讲过了事务的隔离级别嘛，那你线上用的是什么隔离级别？
</div></div></div>

<h6 id="-17"><a href="#-17" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，我们这边用的是Read Commit（读已提交），MySQL默认用的是Repeatable read（可重复读）。选用什么隔离级别，主要看应用场景嘛，因为隔离级别越低，事务并发性能越高
</div></div></div>

<h6 id="-18"><a href="#-18" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
一般互联网公司都选择Read Commit作为主要的隔离级别）
</div></div></div>

<h6 id="-19"><a href="#-19" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
像Repeatable read（可重复读）隔离级别，就有可能因为「间隙锁」导致的死锁问题
</div></div></div>

<h6 id="-20"><a href="#-20" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
但可能你已经知道，MySQL默认的隔离级别为Repeatable read。很大一部分原因是在最开始的时候，MySQL的binlog没有row模式，在read commit隔离级别下会存在「主从数据不一致」的问题
</div></div></div>

<h6 id="-21"><a href="#-21" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
binlog记录了数据库表结构和表数据「变更」，比如update/delete/insert/truncate/create。在MySQL中，主从同步实际上就是应用了binlog来实现的（：
</div></div></div>

<h6 id="-22"><a href="#-22" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
有了该历史原因，所以MySQL就将默认的隔离级别设置为Repeatable read
</div></div></div>

<h6 id="-23"><a href="#-23" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-89983c3f82aef2f68bc720567f0d1980_r.jpg"/>
</div></div></div>


<h6 id="-24"><a href="#-24" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，那我顺便想问下，你们遇到过类似的问题吗：即便走对了索引，线上查询还是慢
</div></div></div>

<h6 id="-25"><a href="#-25" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯嗯，当然遇到过了
</div></div></div>

<h6 id="-26"><a href="#-26" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那你们是怎么做的？
</div></div></div>

<h6 id="-27"><a href="#-27" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果走对了索引，但查询还是慢，那一般来说就是表的数据量实在是太大了
</div></div></div>

<h6 id="-28"><a href="#-28" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
首先，考虑能不能把「旧的数据」给”删掉”，对于我们公司而言，我们都会把数据同步到Hive，说明已经离线存储了一份了
</div></div></div>

<h6 id="-29"><a href="#-29" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那如果「旧的数据」已经没有查询的业务了，那最简单的办法肯定是”删掉”部分数据咯。数据量降低了，那自然，检索速度就快了…
</div></div></div>

<h6 id="-30"><a href="#-30" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，但一般不会删的
</div></div></div>

<h6 id="-31"><a href="#-31" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
没错，只有极少部分业务可以删掉数据（：
</div></div></div>

<h6 id="-32"><a href="#-32" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
随后，就考虑另一种情况，能不能在查询之前，直接走一层缓存（Redis）
</div></div></div>

<h6 id="-33"><a href="#-33" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而走缓存的话，又要看业务能不能忍受读取的「非真正实时」的数据（毕竟Redis和MySQL的数据一致性需要保证），如果查询条件相对复杂且多变的话（涉及各种group by 和sum），那走缓存也不是一种好的办法，维护起来就不方便了…
</div></div></div>

<h6 id="-34"><a href="#-34" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
再看看是不是有「字符串」检索的场景导致查询低效，如果是的话，可以考虑把表的数据导入至Elasticsearch类的搜索引擎，后续的线上查询就直接走Elasticsearch了
</div></div></div>

<h6 id="-35"><a href="#-35" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
MySQL->Elasticsearch需要有对应的同步程序(一般就是监听MySQL的binlog，解析binlog后导入到Elasticsearch)
</div></div></div>

<h6 id="-36"><a href="#-36" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果还不是的话，那考虑要不要根据查询条件的维度，做相对应的聚合表，线上的请求就查询聚合表的数据，不走原表
</div></div></div>

<h6 id="-37"><a href="#-37" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
比如，用户下单后，有一份订单明细，而订单明细表的量级太大。但在产品侧(前台)透出的查询功能是以「天」维度来展示的，那就可以将每个用户的每天数据聚合起来，在聚合表就是一个用户一天只有一条汇总后的数据
</div></div></div>

<h6 id="-38"><a href="#-38" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
查询走聚合后的表，那速度肯定杠杠的（聚合后的表数据量肯定比原始表要少很多）
</div></div></div>

<h6 id="-39"><a href="#-39" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
思路大致的就是「以空间换时间」，相同的数据换别的地方也存储一份，提高查询效率
</div></div></div>

<h6 id="-40"><a href="#-40" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-6a1dc5b0c6ee82fc7337006ff80b67ff_r.jpg"/>
</div></div></div>

<h6 id="-41"><a href="#-41" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那我还想问下，除了读之外，写性能同样有瓶颈，怎么办？
</div></div></div>

<h6 id="-42"><a href="#-42" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
你说到这个，我就不困了
</div></div></div>

<h6 id="-43"><a href="#-43" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果在MySQL读写都有瓶颈，那首先看下目前MySQL的架构是怎么样的
</div></div></div>

<h6 id="-44"><a href="#-44" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果是单库的，那是不是可以考虑升级至主从架构，实现读写分离
</div></div></div>

<h6 id="-45"><a href="#-45" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
简单理解就是：主库接收写请求，从库接收读请求。从库的数据由主库发送的binlog进而更新，实现主从数据一致（在一般场景下，主从的数据是通过异步来保证最终一致性的）
</div></div></div>

<h6 id="-46"><a href="#-46" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-68894ad64aceece371fe98507a6d4232_r.jpg"/>
</div></div></div>

<h6 id="-47"><a href="#-47" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯…
</div></div></div>

<h6 id="-48"><a href="#-48" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果在主从架构下，读写仍存在瓶颈，那就要考虑是否要分库分表了
</div></div></div>

<h6 id="-49"><a href="#-49" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
至少在我前公司的架构下，业务是区分的。流量有流量数据库，广告有广告的数据库，商品有商品的数据库。所以，我这里讲的分库分表的含义是：在原来的某个库的某个表进而拆分
</div></div></div>

<h6 id="-50"><a href="#-50" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
比如，现在我有一张业务订单表，这张订单表在广告库中，假定这张业务订单表已经有1亿数据量了，现在我要分库分表
</div></div></div>

<h6 id="-51"><a href="#-51" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那就会将这张表的数据分至多个广告库以及多张表中（：
</div></div></div>

<h6 id="-52"><a href="#-52" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
分库分表的最明显的好处就是把请求进行均摊（本来单个库单个表有一亿的数据，那假设我分开8个库，那每个库1200+W的数据量，每个库下分8张表，那每张表就150W的数据量）
</div></div></div>

<h6 id="-53"><a href="#-53" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-998aa34d5433837a585196f111bbf771_r.jpg"/>
</div></div></div>

<h6 id="-54"><a href="#-54" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
你们是以什么来作为分库键的？
</div></div></div>

<h6 id="-55"><a href="#-55" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
按照我们这边的经验，一般来说是按照userId的（因为按照用户的维度查询比较多），如果要按照其他的维度进行查询，那还是参照上面的的思路（以空间换时间）
</div></div></div>

<h6 id="-56"><a href="#-56" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那分库分表后的ID是怎么生成的？
</div></div></div>

<h6 id="-57"><a href="#-57" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
这就涉及到分布式ID生成的方式了，思路有很多。有借助MySQL自增的，有借助Redis自增的，有基于「雪花算法」自增的。具体使用哪种方式，那就看公司的技术栈了，一般使用Redis和基于「雪花算法」实现用得比较多
</div></div></div>

<h6 id="-58"><a href="#-58" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
至于为什么强调自增（还是跟索引是有序有关，前面已经讲过了，你应该还记得）
</div></div></div>

<h6 id="-59"><a href="#-59" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-effeac74c8efb2b5c1627884b4ec8843_r.jpg"/>
</div></div></div>

<h6 id="-60"><a href="#-60" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，那如果我要分库分表了，迁移的过程是怎么样的呢
</div></div></div>

<h6 id="-61"><a href="#-61" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
我们一般采取「双写」的方式来进行迁移，大致步骤就是
</div></div></div>

<h6 id="-62"><a href="#-62" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
一、增量的消息各自往新表和旧表写一份
</div></div></div>

<h6 id="-63"><a href="#-63" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
二、将旧表的数据迁移至新库
</div></div></div>

<h6 id="-64"><a href="#-64" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
三、迟早新表的数据都会追得上旧表（在某个节点上数据是同步的）
</div></div></div>

<h6 id="-65"><a href="#-65" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
四、校验新表和老表的数据是否正常（主要看能不能对得上）
</div></div></div>

<h6 id="-66"><a href="#-66" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
五、开启双读（一部分流量走新表，一部分流量走老表），相当于灰度上线的过程
</div></div></div>

<h6 id="-67"><a href="#-67" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
六、读流量全部切新表，停止老表的写入
</div></div></div>

<h6 id="-68"><a href="#-68" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
七、提前准备回滚机制，临时切换失败能恢复正常业务以及有修数据的相关程序
</div></div></div>

<h6 id="-69"><a href="#-69" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-546dffdeecd9c7dc2da98ad5867dfc4c_r.jpg"/>
</div></div></div>

<h6 id="-70"><a href="#-70" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯…今天就到这吧
</div></div></div>

<h6 id="-71"><a href="#-71" class="headerlink" title=""></a></h6><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>数据库表存在一定数据量，就需要有对应的索引</li>
</ul>
<h6 id="-72"><a href="#-72" class="headerlink" title=""></a></h6><ul>
<li>发现慢查询时，检查是否走对索引，是否能用更好的索引进行优化查询速度，查看使用索引的姿势有没有问题</li>
</ul>
<h6 id="-73"><a href="#-73" class="headerlink" title=""></a></h6><ul>
<li>当索引解决不了慢查询时，一般由于业务表的数据量太大导致，利用空间换时间的思想</li>
</ul>
<h6 id="-74"><a href="#-74" class="headerlink" title=""></a></h6><ul>
<li>当读写性能均遇到瓶颈时，先考虑能否升级数据库架构即可解决问题，若不能则需要考虑分库分表</li>
</ul>
<h6 id="-75"><a href="#-75" class="headerlink" title=""></a></h6><ul>
<li>分库分表虽然能解决掉读写瓶颈，但同时会带来各种问题，需要提前调研解决方案和踩坑</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/06/MySQL-%E9%97%B2%E8%B0%88-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/06/MySQL-%E9%97%B2%E8%B0%88-2/" class="post-title-link" itemprop="url">MySQL 闲谈 2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-06 16:14:33 / Modified: 16:55:29" itemprop="dateCreated datePublished" datetime="2022-11-06T16:14:33+08:00">2022-11-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
你是怎么理解InnoDB引擎中的事务的？
</div></div></div>

<h6 id=""><a href="#" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在我的理解下，事务可以使「一组操作」要么全部成功，要么全部失败
</div></div></div>

<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
事务其目的是为了「保证数据最终的一致性」
</div></div></div>


<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
举个例子，我给你发支付宝转了888块红包。那自然我的支付宝余额会扣减888块，你的支付宝余额会增加888块
</div></div></div>


<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而事务就是保证我的余额扣减跟你的余额增添是同时成功或者同时失败的，这样这次转账就正常了
</div></div></div>


<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-3ebaa5e83396dabab44bc9d6371a384b_r.jpg"/>
</div></div></div>


<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，那你了解事务的几大特性吗？
</div></div></div>

<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，就是ACID嘛，分别是原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）
</div></div></div>

<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
原子性指的是：当前事务的操作要么同时成功，要么同时失败。原子性由undo log日志来保证，因为undo log记载着数据修改前的信息
</div></div></div>

<h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
比如我们要 insert 一条数据了，那undo log 会记录的一条对应的 delete 日志。我们要 update 一条记录时，那undo log会记录之前的「旧值」的update记录
</div></div></div>

<h6 id="-9"><a href="#-9" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
如果执行事务过程中出现异常的情况，那执行「回滚」。InnoDB引擎就是利用undo log记录下的数据，来将数据「恢复」到事务开始之前
</div></div></div>

<h6 id="-10"><a href="#-10" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-8fd6ccf7a2ef047768f34992bd1c7c30_r.jpg"/>
</div></div></div>

<h6 id="-11"><a href="#-11" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
一致性我稍稍往后讲，我先来说下隔离性
</div></div></div>

<h6 id="-12"><a href="#-12" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯…
</div></div></div>

<h6 id="-13"><a href="#-13" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
隔离性指的是：在事务「并发」执行时，他们内部的操作不能互相干扰。如果多个事务可以同时操作一个数据，那么就会产生脏读、重复读、幻读的问题
</div></div></div>

<h6 id="-14"><a href="#-14" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
于是，事务与事务之间需要存在「一定」的隔离，在InnoDB引擎中，定义了四种隔离级别供我们使用
</div></div></div>

<h6 id="-15"><a href="#-15" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
分别是：read uncommit(读未提交)、read commit (读已提交)、repeatable read (可重复复读)、serializable (串行)
</div></div></div>

<h6 id="-16"><a href="#-16" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
不同的隔离级别对事务之间的隔离性是不一样的（级别越高事务隔离性越好，但性能就越低），而隔离性是由MySQL的各种锁来实现的，只是它屏蔽了加锁的细节
</div></div></div>

<h6 id="-17"><a href="#-17" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-12c1d8d4396bb7d0383f72b5eb4d77d6_r.jpg"/>
</div></div></div>

<h6 id="-18"><a href="#-18" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
持久性指的就是：一旦提交了事务，它对数据库的改变就应该是永久性的。说白了就是，会将数据持久化在硬盘上
</div></div></div>

<h6 id="-19"><a href="#-19" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而持久性由redo log 日志来保证，当我们要修改数据时，MySQL是先把这条记录所在的「页」找到，然后把该页加载到内存中，将对应记录进行修改
</div></div></div>

<h6 id="-20"><a href="#-20" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
为了防止内存修改完了，MySQL就挂掉了（如果内存改完，直接挂掉，那这次的修改相当于就丢失了）
</div></div></div>

<h6 id="-21"><a href="#-21" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
MySQL引入了redo log，内存写完了，然后会写一份redo log，这份redo log记载着这次在某个页上做了什么修改
</div></div></div>

<h6 id="-22"><a href="#-22" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
即便MySQL在中途挂了，我们还可以根据redo log来对数据进行恢复
</div></div></div>

<h6 id="-23"><a href="#-23" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
redo log 是顺序写的，写入速度很快。并且它记录的是物理修改（xxxx页做了xxx修改），文件的体积很小，恢复速度也很快
</div></div></div>

<h6 id="-24"><a href="#-24" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-2325a411c8f9da2e8c5f83367d913793_r.jpg"/>
</div></div></div>

<h6 id="-25"><a href="#-25" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
回头再来讲一致性，「一致性」可以理解为我们使用事务的「目的」，而「隔离性」「原子性」「持久性」均是为了保障「一致性」的手段，保证一致性需要由应用程序代码来保证
</div></div></div>

<h6 id="-26"><a href="#-26" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
比如，如果事务在发生的过程中，出现了异常情况，此时你就得回滚事务，而不是强行提交事务来导致数据不一致
</div></div></div>

<h6 id="-27"><a href="#-27" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-e5c89083071510afe2afd6e6dc337efa_r.jpg"/>
</div></div></div>

<h6 id="-28"><a href="#-28" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，挺好的，讲了蛮多的
</div></div></div>

<h6 id="-29"><a href="#-29" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
刚才你也提到了隔离性嘛，然后你说在MySQL中有四种隔离级别，能分别来介绍下吗？
</div></div></div>

<h6 id="-30"><a href="#-30" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，为了讲清楚隔离级别，我顺带来说下MySQL锁相关的知识吧
</div></div></div>

<h6 id="-31"><a href="#-31" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在InnoDB引擎下，按锁的粒度分类，可以简单分为行锁和表锁
</div></div></div>

<h6 id="-32"><a href="#-32" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
行锁实际上是作用在索引之上的（索引上次已经说过了，这里就不赘述了）。当我们的SQL命中了索引，那锁住的就是命中条件内的索引节点（这种就是行锁），如果没有命中索引，那我们锁的就是整个索引树（表锁）
</div></div></div>

<h6 id="-33"><a href="#-33" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
简单来说就是：锁住的是整棵树还是某几个节点，完全取决于SQL条件是否有命中到对应的索引节点
</div></div></div>

<h6 id="-34"><a href="#-34" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而行锁又可以简单分为读锁（共享锁、S锁）和写锁（排它锁、X锁）
</div></div></div>

<h6 id="-35"><a href="#-35" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
读锁是共享的，多个事务可以同时读取同一个资源，但不允许其他事务修改。写锁是排他的，写锁会阻塞其他的写锁和读锁
</div></div></div>

<h6 id="-36"><a href="#-36" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-4ed4e54af979a73c24db83133be59359_r.jpg"/>
</div></div></div>

<h6 id="-37"><a href="#-37" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
我现在就再回到隔离级别上吧，就直接以例子来说明啦
</div></div></div>

<h6 id="-38"><a href="#-38" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯…
</div></div></div>

<h6 id="-39"><a href="#-39" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
首先来说下read uncommit(读未提交)。比如说：A向B转账，A执行了转账语句，但A还没有提交事务，B读取数据，发现自己账户钱变多了！B跟A说，我已经收到钱了。A回滚事务【rollback】，等B再查看账户的钱时，发现钱并没有多
</div></div></div>

<h6 id="-40"><a href="#-40" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
简单的定义就是：事务B读取到了事务A还没提交的数据，这种用专业术语来说叫做「脏读」
</div></div></div>

<h6 id="-41"><a href="#-41" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
对于锁的维度而言，其实就是在read uncommit隔离级别下，读不会加任何锁，而写会加排他锁。读什么锁都不加，这就让排他锁无法排它了
</div></div></div>

<h6 id="-42"><a href="#-42" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-6792ec868544bf39078b7e9255ff4f53_r.jpg"/>
</div></div></div>

<h6 id="-43"><a href="#-43" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而我们又知道，对于更新操作而言，InnoDB是肯定会加写锁的（数据库是不可能允许在同一时间，更新同一条记录的）。而读操作，如果不加任何锁，那就会造成上面的脏读
</div></div></div>

<h6 id="-44"><a href="#-44" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
脏读在生产环境下肯定是无法接受的，那如果读加锁的话，那意味着：当更新数据的时，就没办法读取了，这会极大地降低数据库性能
</div></div></div>

<h6 id="-45"><a href="#-45" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在MySQL InnoDB引擎层面，又有新的解决方案（解决加锁后读写性能问题），叫做MVCC(Multi-Version Concurrency Control)多版本并发控制
</div></div></div>

<h6 id="-46"><a href="#-46" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-7e397fcccc1d5dc2a519b45bf36d334f_r.jpg"/>
</div></div></div>

<h6 id="-47"><a href="#-47" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在MVCC下，就可以做到读写不阻塞，且避免了类似脏读这样的问题
</div></div></div>

<h6 id="-48"><a href="#-48" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
那MVCC是怎么做的呢？
</div></div></div>

<h6 id="-49"><a href="#-49" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
MVCC通过生成数据快照（Snapshot)，并用这个快照来提供一定级别（语句级或事务级）的一致性读取
</div></div></div>

<h6 id="-50"><a href="#-50" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
回到事务隔离级别下，针对于 read commit (读已提交) 隔离级别，它生成的就是语句级快照，而针对于repeatable read (可重复读)，它生成的就是事务级的快照
</div></div></div>


<h6 id="-51"><a href="#-51" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-93fe1254a1c756b4ec092e44a2c6de12_r.jpg"/>
</div></div></div>

<h6 id="-52"><a href="#-52" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
前面提到过read uncommit隔离级别下会产生脏读，而read commit (读已提交) 隔离级别解决了脏读。思想其实很简单：在读取的时候生成一个”版本号”，等到其他事务commit了之后，才会读取最新已commit的”版本号”数据
</div></div></div>

<h6 id="-53"><a href="#-53" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
比如说：事务A读取了记录(生成版本号)，事务B修改了记录(此时加了写锁)，事务A再读取的时候，是依据最新的版本号来读取的(当事务B执行commit了之后，会生成一个新的版本号)，如果事务B还没有commit，那事务A读取的还是之前版本号的数据
</div></div></div>

<h6 id="-54"><a href="#-54" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
通过「版本」的概念，这样就解决了脏读的问题，而「版本」其实就是对应快照的数据
</div></div></div>

<h6 id="-55"><a href="#-55" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
read commit (读已提交) 解决了脏读，但也会有其他并发的问题。「不可重复读」：一个事务读取到另外一个事务已经提交的数据，也就是说一个事务可以看到其他事务所做的修改
</div></div></div>

<h6 id="-56"><a href="#-56" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
不可重复读的例子：A查询数据库得到数据，B去修改数据库的数据，导致A多次查询数据库的结果都不一样【危害：A每次查询的结果都是受B的影响的】
</div></div></div>

<h6 id="-57"><a href="#-57" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
了解MVCC基础之后，就很容易想到repeatable read (可重复复读)隔离级别是怎么避免不可重复读的问题了（前面也提到了）
</div></div></div>

<h6 id="-58"><a href="#-58" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
repeatable read (可重复复读)隔离级别是「事务级别」的快照！每次读取的都是「当前事务的版本」，即使当前数据被其他事务修改了(commit)，也只会读取当前事务版本的数据
</div></div></div>

<h6 id="-59"><a href="#-59" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-7e397fcccc1d5dc2a519b45bf36d334f_r.jpg"/>
</div></div></div>

<h6 id="-60"><a href="#-60" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而repeatable read (可重复复读)隔离级别会存在幻读的问题，「幻读」指的是指在一个事务内读取到了别的事务插入的数据，导致前后读取不一致
</div></div></div>

<h6 id="-61"><a href="#-61" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在InnoDB引擎下的的repeatable read (可重复复读)隔离级别下，快照读MVCC影响下，已经解决了幻读的问题（因为它是读历史版本的数据）
</div></div></div>

<h6 id="-62"><a href="#-62" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而如果是当前读（指的是 select * from table for update），则需要配合间隙锁来解决幻读的问题
</div></div></div>

<h6 id="-63"><a href="#-63" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
剩下的就是serializable (串行)隔离级别了，它的最高的隔离级别，相当于不允许事务的并发，事务与事务之间执行是串行的，它的效率最低，但同时也是最安全的
</div></div></div>

<h6 id="-64"><a href="#-64" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，不妨来说下MVCC的原理？
</div></div></div>

<h6 id="-65"><a href="#-65" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
MVCC的主要是通过read view和undo log来实现的
</div></div></div>

<h6 id="-66"><a href="#-66" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
<img src="/pictures/MySQL-闲谈/v2-cc344b44fe34fc54ec6c9e2f28a4aa2d_r.jpg"/>
</div></div></div>

<h6 id="-67"><a href="#-67" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
undo log前面也提到了，它会记录修改数据之前的信息，事务中的原子性就是通过undo log来实现的。所以，有undo log可以帮我们找到「版本」的数据
</div></div></div>

<h6 id="-68"><a href="#-68" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而read view 实际上就是在查询时，InnoDB会生成一个read view，read view 有几个重要的字段，分别是：trx_ids（尚未提交commit的事务版本号集合），up_limit_id（下一次要生成的事务ID值），low_limit_id（尚未提交版本号的事务ID最小值）以及creator_trx_id（当前的事务版本号）
</div></div></div>

<h6 id="-69"><a href="#-69" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
在每行数据有两列隐藏的字段，分别是DB_TRX_ID（记录着当前ID）以及DB_ROLL_PTR（指向上一个版本数据在undo log 里的位置指针）
</div></div></div>

<h6 id="-70"><a href="#-70" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
铺垫到这了，很容易就发现，MVCC其实就是靠「比对版本」来实现读写不阻塞，而版本的数据存在于undo log中
</div></div></div>

<h6 id="-71"><a href="#-71" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
而针对于不同的隔离级别（read commit和repeatable read），无非就是read commit隔离级别下，每次都获取一个新的read view，repeatable read隔离级别则每次事务只获取一个read view
</div></div></div>


<h6 id="-72"><a href="#-72" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center; margin:5%">
嗯，OK的。细节就不考究了，今天就到这里吧
</div></div></div>


<h6 id="-73"><a href="#-73" class="headerlink" title=""></a></h6><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>事务为了保证数据的最终一致性</li>
</ul>
<h6 id="-74"><a href="#-74" class="headerlink" title=""></a></h6><ul>
<li><p>事务有四大特性，分别是原子性、一致性、隔离性、持久性</p>
<ul>
<li>原子性由undo log保证</li>
<li>持久性由redo log 保证</li>
<li>隔离性由数据库隔离级别供我们选择，分别有read uncommit,read commit,repeatable read,serializable</li>
<li>一致性是事务的目的，一致性由应用程序来保证</li>
</ul>
</li>
</ul>
<h6 id="-75"><a href="#-75" class="headerlink" title=""></a></h6><ul>
<li>事务并发会存在各种问题，分别有脏读、重复读、幻读问题，上面的不同隔离级别可以解决掉由于并发事务所造成的问题，而隔离级别实际上就是由MySQL锁来实现的</li>
</ul>
<h6 id="-76"><a href="#-76" class="headerlink" title=""></a></h6><ul>
<li>频繁加锁会导致数据库性能低下，引入了MVCC多版本控制来实现读写不阻塞，提高数据库性能</li>
</ul>
<h6 id="-77"><a href="#-77" class="headerlink" title=""></a></h6><ul>
<li>MVCC原理即通过read view 以及undo log来实现</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/05/MySQL-%E9%97%B2%E8%B0%88-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/MySQL-%E9%97%B2%E8%B0%88-1/" class="post-title-link" itemprop="url">MySQL 闲谈 1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-05 22:00:29" itemprop="dateCreated datePublished" datetime="2022-11-05T22:00:29+08:00">2022-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-06 16:55:29" itemprop="dateModified" datetime="2022-11-06T16:55:29+08:00">2022-11-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
对MySQL InnoDB引擎的索引了解吗？
</div></div></div>

<h6 id=""><a href="#" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
嗯啊，使用索引可以加快查询速度，其实就是将无序的数据变成有序（有序就能加快检索速度）
</div></div></div>

<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
在InnoDB引擎中，索引的底层数据结构是B+树
</div></div></div>

<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
那为什么不使用红黑树或者B树呢？
</div></div></div>

<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
MySQL的数据是存储在硬盘的，在查询时一般是不能「一次性」把全部数据加载到内存中
</div></div></div>

<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
红黑树是「二叉查找树」的变种，一个Node节点只能存储一个Key和一个Value
</div></div></div>

<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
B和B+树跟红黑树不一样，它们算是「多路搜索树」，相较于「二叉搜索树」而言，一个Node节点可以存储的信息会更多，「多路搜索树」的高度会比「二叉搜索树」更低
</div></div></div>

<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
了解了区别之后，其实就很容易发现，在数据不能一次加载至内存的场景下，数据需要被检索出来，选择B或B+树的理由就很充分了（一个Node节点存储信息更多（相较于二叉搜索树），树的高度更低，树的高度影响检索的速度）
</div></div></div>

<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
B+树相对于B树而言，它又有两种特性
</div></div></div>

<h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
一、B+树非叶子节点不存储数据，在相同的数据量下，B+树更加矮壮。（这个应该不用多解释了，数据都存储在叶子节点上，非叶子节点的存储能存储更多的索引，所以整棵树就更加矮壮）
</div></div></div>

<h6 id="-9"><a href="#-9" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
二、B+树叶子节点之间组成一个链表，方便于遍历查询（遍历操作在MySQL中比较常见）
</div></div></div>

<h6 id="-10"><a href="#-10" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
<img src="/pictures/MySQL-闲谈/v2-54a18a07f7adfbda09983b815a92c5b8_r.jpg"/>
</div></div></div>

<h6 id="-11"><a href="#-11" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
我稍微解释一下吧，你可以脑补下画面
</div></div></div>

<h6 id="-12"><a href="#-12" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
我们在MySQL InnoDB引擎下，每创建一个索引，相当于生成了一颗B+树
</div></div></div>

<h6 id="-13"><a href="#-13" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
如果该索引是「聚集(聚簇)索引」，那当前B+树的叶子节点存储着「主键和当前行的数据」
</div></div></div>

<h6 id="-14"><a href="#-14" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
如果该索引是「非聚簇索引」，那当前B+树的叶子节点存储着「主键和当前索引列值」
</div></div></div>

<h6 id="-15"><a href="#-15" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
比如写了一句sql：select * from user where id >=10，那只要定位到id为10的记录，然后在叶子节点之间通过遍历链表(叶子节点组成的链表)，即可以找到往后的记录了
</div></div></div>

<h6 id="-16"><a href="#-16" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
由于B树是会在非叶子节点也存储数据，要遍历的时候可能就得跨层检索，相对麻烦些
</div></div></div>

<h6 id="-17"><a href="#-17" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
基于树的层级以及业务使用场景的特性，所以MySQL选择了B+树作为索引的底层数据结构
</div></div></div>

<h6 id="-18"><a href="#-18" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
对于哈希结构，其实InnoDB引擎是「自适应」哈希索引的（hash索引的创建由InnoDB存储引擎引擎自动优化创建，我们是干预不了）
</div></div></div>

<h6 id="-19"><a href="#-19" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
嗯…那我了解了，顺便想问下，你知道什么叫做回表吗？
</div></div></div>

<h6 id="-20"><a href="#-20" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
所谓的回表其实就是，当我们使用索引查询数据时，检索出来的数据可能包含其他列，但走的索引树叶子节点只能查到当前列值以及主键ID，所以需要根据主键ID再去查一遍数据，得到SQL 所需的列
</div></div></div>

<h6 id="-21"><a href="#-21" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
举个例子，我这边建了给订单号ID建了个索引，但我的SQL 是：select orderId,orderName from orderdetail where orderId = 123
</div></div></div>

<h6 id="-22"><a href="#-22" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
SQL都订单ID索引，但在订单ID的索引树的叶子节点只有orderId和Id，而我们还想检索出orderName，所以MySQL 会拿到ID再去查出orderName给我们返回，这种操作就叫回表
</div></div></div>

<h6 id="-23"><a href="#-23" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
<img src="/pictures/MySQL-闲谈/v2-2393680d1df54c696f97c8194b34237c_r.jpg"/>
</div></div></div>

<h6 id="-24"><a href="#-24" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
想要避免回表，也可以使用覆盖索引（能使用就使用，因为避免了回表操作）
</div></div></div>

<h6 id="-25"><a href="#-25" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
所谓的覆盖索引，实际上就是你想要查出的列刚好在叶子节点上都存在，比如我建了orderId和orderName联合索引，刚好我需要查询也是orderId和orderName，这些数据都存在索引树的叶子节点上，就不需要回表操作了
</div></div></div>

<h6 id="-26"><a href="#-26" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
既然你也提到了联合索引，我想问下你了解最左匹配原则吗？
</div></div></div>

<h6 id="-27"><a href="#-27" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
嗯，说明这个概念，还是举例子比较容易说明
</div></div></div>

<h6 id="-28"><a href="#-28" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
如有索引 (a,b,c,d)，查询条件 a=1 and b=2 and c>3 and d=4，则会在每个节点依次命中a、b、c，无法命中d
</div></div></div>

<h6 id="-29"><a href="#-29" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
先匹配最左边的，索引只能用于查找key是否存在（相等），遇到范围查询 (>、<、between、like左匹配)等就不能进一步匹配了，后续退化为线性查找
</div></div></div>

<h6 id="-30"><a href="#-30" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
这就是最左匹配原则
</div></div></div>

<h6 id="-31"><a href="#-31" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
<img src="/pictures/MySQL-闲谈/v2-6d6af5c6cfe9be27d1f41af4d7860d3a_r.jpg"/>
</div></div></div>

<h6 id="-32"><a href="#-32" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
嗯嗯，我还想问下你们主键是怎么生成的？
</div></div></div>

<h6 id="-33"><a href="#-33" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
主键就自增的
</div></div></div>

<h6 id="-34"><a href="#-34" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
那假设我不用MySQL自增的主键，你觉得会有什么问题呢？
</div></div></div>

<h6 id="-35"><a href="#-35" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
首先主键得保证它的唯一性和空间尽可能短吧，这两块是需要考虑的
</div></div></div>

<h6 id="-36"><a href="#-36" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
另外，由于索引的特性（有序），如果生成像uuid类似的主键，那插入的的性能是比自增的要差的
</div></div></div>

<h6 id="-37"><a href="#-37" class="headerlink" title=""></a></h6><div align="right"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
因为生成的uuid，在插入时有可能需要移动磁盘块（比如，块内的空间在当前时刻已经存储满了，但新生成的uuid需要插入已满的块内，就需要移动块的数据）
</div></div></div>

<h6 id="-38"><a href="#-38" class="headerlink" title=""></a></h6><div align="left"><div style="width:60%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
OK…
</div></div></div>

<h6 id="-39"><a href="#-39" class="headerlink" title=""></a></h6><div align="right"><div style="width:80%; border-style:solid; border-width:1px; border-radius:15px"><div style="text-align:center;margin:5%">
<img src="/pictures/MySQL-闲谈/v2-ca51dbec74c22029ebde0650378dfbfd_r.jpg"/>
</div></div></div>

<h6 id="-40"><a href="#-40" class="headerlink" title=""></a></h6><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li><p><strong>为什么B+树？</strong></p>
<ul>
<li>数据无法一次load到内存，B+树是多路搜索树，只有叶子节点才存储数据，叶子节点之间链表进行关联。（树矮，易遍历）</li>
</ul>
</li>
</ul>
<h6 id="-41"><a href="#-41" class="headerlink" title=""></a></h6><ul>
<li><p><strong>什么是回表？</strong></p>
<ul>
<li>非聚簇索引在叶子节点只存储列值以及主键ID，有条件下尽可能用覆盖索引避免回表操作，提高查询速度</li>
</ul>
</li>
</ul>
<h6 id="-42"><a href="#-42" class="headerlink" title=""></a></h6><ul>
<li><p><strong>什么是最左匹配原则？</strong></p>
<ul>
<li>从最左边为起点开始连续匹配，遇到范围查询终止</li>
</ul>
</li>
</ul>
<h6 id="-43"><a href="#-43" class="headerlink" title=""></a></h6><ul>
<li><p><strong>主键非自增会有什么问题？</strong></p>
<ul>
<li>插入效率下降，存在移动块的数据问题</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/05/Markdown-%E5%AF%B9%E8%AF%9D%E6%A1%86%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/Markdown-%E5%AF%B9%E8%AF%9D%E6%A1%86%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Markdown 对话框</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-05 20:43:19" itemprop="dateCreated datePublished" datetime="2022-11-05T20:43:19+08:00">2022-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-06 20:10:55" itemprop="dateModified" datetime="2022-11-06T20:10:55+08:00">2022-11-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h3><img src="/pictures/markdown 对话框/2022.11.05.21.09.58.png"/>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;div align=&quot;right&quot;&gt;</span><br><span class="line">&lt;div style=&quot;width:47%; border-style:solid; border-width:1px; border-radius:15px&quot;&gt;</span><br><span class="line">&lt;div style=&quot;text-align:center;margin:5%&quot;&gt;</span><br><span class="line">这是右边</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">###### </span><br><span class="line"></span><br><span class="line">&lt;div align=&quot;left&quot;&gt;</span><br><span class="line">&lt;div style=&quot;width:47%; border-style:solid; border-width:1px; border-radius:15px&quot;&gt;</span><br><span class="line">&lt;div style=&quot;text-align:center;margin:5%&quot;&gt;</span><br><span class="line">这是左边</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/05/Linux-%E6%9F%A5%E7%9C%8B%E7%A1%AC%E7%9B%98%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/Linux-%E6%9F%A5%E7%9C%8B%E7%A1%AC%E7%9B%98%E7%A9%BA%E9%97%B4/" class="post-title-link" itemprop="url">Linux 查看硬盘空间</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-05 15:46:02 / Modified: 15:48:06" itemprop="dateCreated datePublished" datetime="2022-11-05T15:46:02+08:00">2022-11-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">du -sh ./*</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/05/VLC-Linux-%E5%AE%89%E8%A3%85%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%AE%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/VLC-Linux-%E5%AE%89%E8%A3%85%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%AE%E5%BD%95/" class="post-title-link" itemprop="url">VLC Linux 安装在自定义目录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-05 15:16:56 / Modified: 15:37:45" itemprop="dateCreated datePublished" datetime="2022-11-05T15:16:56+08:00">2022-11-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>apt 只下载包及其依赖而不安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sudo apt-get install -d &lt;软件包&gt;</span><br><span class="line">sudo apt-get install -d vlc</span><br></pre></td></tr></table></figure>

<p>这将会下载到这个目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/cache/apt/archives/</span><br></pre></td></tr></table></figure>

<p>为了只是获得想要的包和依赖，应该先清空这个目录再下载</p>
<p>将 <strong>&#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;</strong> 的包以及依赖移到某一个目录保存</p>
<p>然后把这些包安装到指定目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for file in packagesPath:</span><br><span class="line">do </span><br><span class="line">	echo $file</span><br><span class="line">	sudo dpkg -x $file customInstallPath</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>在 customInstallPath 下编写一个启动脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">HERE=&quot;$(dirname &quot;$(readlink -f &quot;$0&quot;)&quot;)&quot;</span><br><span class="line">export UNION_PRELOAD=$HERE</span><br><span class="line">export LD_PRELOAD=$HERE/libunionpreload.so</span><br><span class="line">export PATH=$HERE/usr/bin/:$HERE/usr/sbin/:$HERE/usr/games/:$HERE/bin/:$HERE/opt/vlc/:$HERE/sbin/:$PATH</span><br><span class="line">export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/:$HERE/usr/lib/:$HERE/usr/lib/x86_64-linux-gnu/:$HERE/lib/:$HERE/lib/x86_64-linux-gnu/:$HERE/usr/lib/x86_64-linux-gnu/vlc/:$LD_LIBRARY_PATH</span><br><span class="line">export QT_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/qt5/plugins/:$HERE/usr/lib/x86_64-linux-gnu/qt5/plugins/:$QT_PLUGIN_PATH</span><br><span class="line">export XDG_DATA_DIRS=$HERE/usr/share/:$XDG_DATA_DIRS</span><br><span class="line">exec $HERE/usr/bin/vlc &quot;$@&quot;</span><br></pre></td></tr></table></figure>

<p>保存并赋予这个启动脚本执行权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x launch.sh</span><br></pre></td></tr></table></figure>

<p>执行 launch.sh 就可以运行 vlc 了</p>
<p>这个脚本里面的 bash 变量是程序内部执行需要的变量，并不是环境变量，只有知道软件构建运行的源码才可以写出来，所以这个脚本并不是通用的，只适合 vlc</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/05/wayland-wemeet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/wayland-wemeet/" class="post-title-link" itemprop="url">Wayland Wemeet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-05 14:45:11 / Modified: 14:54:21" itemprop="dateCreated datePublished" datetime="2022-11-05T14:45:11+08:00">2022-11-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>腾讯会议不支持 Wayland</p>
<img src="/pictures/wayland-wemeet/2022-04-19-13-25-31屏幕截图.png"/>


<h6 id=""><a href="#" class="headerlink" title=""></a></h6><p>解决方法</p>
<ul>
<li><p>进入 &#x2F;opt&#x2F;wemeet 目录</p>
</li>
<li><p>编辑 wemeetapp.sh 文件</p>
</li>
<li><p>在 export QT_PLUGIN_PATH&#x3D;”${HERE}&#x2F;plugins” 后添加如下三行代码后保存</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export XDG_SESSION_TYPE=x11</span><br><span class="line">export QT_QPA_PLATFORM=xcb</span><br><span class="line">unset WAYLAND_DISPLAY</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启即可</p>
</li>
</ul>
<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><p>缺点</p>
<ul>
<li>由于 Wayland 的限制，腾讯会议现在无法捕捉到屏幕，自然“共享屏幕”也就失效了，实际效果是当尝试共享屏幕时，共享的是 pure black</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/11/04/MARO-Distibuted-toolkit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/04/MARO-Distibuted-toolkit/" class="post-title-link" itemprop="url">MARO Distibuted Toolkit</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-11-04 18:15:29 / Modified: 22:37:56" itemprop="dateCreated datePublished" datetime="2022-11-04T18:15:29+08:00">2022-11-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="MARO-三层框架"><a href="#MARO-三层框架" class="headerlink" title="MARO 三层框架"></a>MARO 三层框架</h3><img src="/pictures/maro-distributed-toolkit/maro_overview.svg"/>

<h6 id=""><a href="#" class="headerlink" title=""></a></h6><h4 id="接下来展示的是第三层-Distibuted-toolkit"><a href="#接下来展示的是第三层-Distibuted-toolkit" class="headerlink" title="接下来展示的是第三层 Distibuted toolkit"></a>接下来展示的是第三层 Distibuted toolkit</h4><img src="/pictures/maro-distributed-toolkit/overview.svg"/>

<ul>
<li><p>MARO Distibuted Toolkit 遵循 message-passing 模式，即不同组件之间的协作基于消息<strong>发送</strong>和<strong>接收</strong></p>
</li>
<li><p>典型的 <strong>master&#x2F;worker</strong> 分布式程序通常包含以下步骤</p>
<ul>
<li>master 会将任务（w&#x2F; or w&#x2F;o data）发送到 worker</li>
<li>worker 将在其本地计算环境或本地设备中完成任务</li>
<li>worker 将计算结果返回到 master</li>
</ul>
</li>
</ul>
<img src="/pictures/maro-distributed-toolkit/v2-b5f0db269480aceb6590007f8ad9dfe8_r.jpg" style="zoom:40%"/>

    
<ul>
<li>根据实际需要，主控组件和工作组件之间的通信方式可以是同步的，也可以是异步的</li>
</ul>
<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><h4 id="关键部件"><a href="#关键部件" class="headerlink" title="关键部件"></a>关键部件</h4><img src="/pictures/maro-distributed-toolkit/key_components.svg"/> 

<ul>
<li><h5 id="Comunication"><a href="#Comunication" class="headerlink" title="Comunication"></a>Comunication</h5><ul>
<li><h5 id="大致功能预览"><a href="#大致功能预览" class="headerlink" title="大致功能预览"></a>大致功能预览</h5><ul>
<li><p>提供通用的消息传递接口</p>
<ul>
<li>send, receive</li>
<li>broadcast</li>
<li>scatter</li>
</ul>
</li>
</ul>
<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><ul>
<li><p>通信组件使用<strong>可替换</strong>的通信协议驱动程序来适应不同的通信协议栈</p>
<ul>
<li>TCP&#x2F;IP</li>
<li>InfiniBand</li>
</ul>
</li>
</ul>
<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><ul>
<li><p>Peer Discovering</p>
</li>
<li><p>部分故障恢复</p>
</li>
<li><p>条件事件自动调度</p>
</li>
</ul>
</li>
</ul>
<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><ul>
<li><h5 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h5>  <img src="/pictures/maro-distributed-toolkit/proxy.svg"/>

<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><ul>
<li>Proxy 提供通信原语的实现，是通信操作接口，是通信组件的主要实体</li>
<li>Proxy 默认使用 ZeroMQ 框架</li>
<li>Proxy 为基于 Redis 的 peer discovering 提供支持</li>
<li>分布式通信原语常见操作如下<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Broadcast</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-c9aa7762a6ec00d370c58de183441362_r.jpg"/>


  <img src="/pictures/maro-distributed-toolkit/v2-1ff295f93679ebe9a03ad510259ead8b_r.jpg"/></li>
</ul>
<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><h6 id="-9"><a href="#-9" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Scatter</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-be03c436a4f699aa001deb4490f33813_r.jpg"/>

  <img src="/pictures/maro-distributed-toolkit/v2-f17bd118677f919e255d5b1689fc66dc_r.jpg"/></li>
</ul>
<h6 id="-10"><a href="#-10" class="headerlink" title=""></a></h6><h6 id="-11"><a href="#-11" class="headerlink" title=""></a></h6><h6 id="-12"><a href="#-12" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Reduce (强调聚合之后处理)</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-466054a11a994842eb1b062b13b9bde3_r.png"/>

  
  <img src="/pictures/maro-distributed-toolkit/v2-c7bdad601780f9798a62c2dfb1bbef4d_r.jpg"/></li>
</ul>
<h6 id="-13"><a href="#-13" class="headerlink" title=""></a></h6><h6 id="-14"><a href="#-14" class="headerlink" title=""></a></h6><h6 id="-15"><a href="#-15" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Gather (单纯聚合没有额外处理)</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-3b2ec50810fc8d92971a4b7c0b800b1b_r.jpg"/>

  <img src="/pictures/maro-distributed-toolkit/v2-dc3fcf248c39b4a76947bcea140840d1_720w.webp"/></li>
</ul>
<h6 id="-16"><a href="#-16" class="headerlink" title=""></a></h6><h6 id="-17"><a href="#-17" class="headerlink" title=""></a></h6><h6 id="-18"><a href="#-18" class="headerlink" title=""></a></h6><ul>
<li><p><strong>All Reduce</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-0e90f4c9b66d42dfa41145d3b6a52361_r.jpg"/>


  <img src="/pictures/maro-distributed-toolkit/v2-80b1bd60a2fdefb19f792fdf193c6d76_r.jpg"/></li>
</ul>
<h6 id="-19"><a href="#-19" class="headerlink" title=""></a></h6><h6 id="-20"><a href="#-20" class="headerlink" title=""></a></h6><h6 id="-21"><a href="#-21" class="headerlink" title=""></a></h6><ul>
<li><p><strong>All Gather</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-ce5261aec55090a1f9e9dd5233b22af9_r.jpg"/>

  
  <img src="/pictures/maro-distributed-toolkit/v2-831e0b04646c78f9e74bf4f29c35b8af_720w.webp"/></li>
</ul>
<h6 id="-22"><a href="#-22" class="headerlink" title=""></a></h6><h6 id="-23"><a href="#-23" class="headerlink" title=""></a></h6><h6 id="-24"><a href="#-24" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Reduce Scatter</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-14cdd631faae00452885a116dd36737c_720w.webp"/></li>
</ul>
<h6 id="-25"><a href="#-25" class="headerlink" title=""></a></h6><h6 id="-26"><a href="#-26" class="headerlink" title=""></a></h6><h6 id="-27"><a href="#-27" class="headerlink" title=""></a></h6><ul>
<li><p><strong>All to All</strong></p>
  <img src="/pictures/maro-distributed-toolkit/v2-945ffd7612632fa88ed2bc68ec832071_r.jpg"/></li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-28"><a href="#-28" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Message</strong></p>
<ul>
<li><p>用于打包组件之间的通信内容，消息实例的主要属性包括</p>
<ul>
<li>tag：自定义属性，可用于通过 <strong>conditional event register table</strong> 实现自动调度逻辑</li>
<li>source：message 发送者的别名</li>
<li>destination：message 接收者的别名</li>
<li>payload：用于远程函数调用的 Python 对象</li>
<li>session_id（自动生成）：特定会话的 UUID ，一个会话可能包含多条消息</li>
<li>message_id（自动生成）：特定消息的 UUID</li>
</ul>
</li>
</ul>
<h6 id="-29"><a href="#-29" class="headerlink" title=""></a></h6><ul>
<li><p>Example</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from maro.communication import Message</span><br><span class="line"></span><br><span class="line">message = Message(tag=&quot;check_in&quot;,</span><br><span class="line">                  source=&quot;worker_001&quot;,</span><br><span class="line">                  destination=&quot;master&quot;,</span><br><span class="line">                  body=&quot;&quot;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="-30"><a href="#-30" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Session Message</strong></p>
<ul>
<li><p>MARO 为常见的分布式场景提供了两种预定义的会话类型</p>
<ul>
<li><p><strong>Task Session</strong></p>
<ul>
<li><p>存在 master 和 worker 关系</p>
</li>
<li><p>用于描述从 master 发送到 worker 的 computing task</p>
<ul>
<li>master 将 task 发送给 worker</li>
<li>一旦 worker 收到 task ，worker 就开始执行 task</li>
<li>worker 将 computing result 返回给 master</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-31"><a href="#-31" class="headerlink" title=""></a></h6><ul>
<li><p><strong>Notification Session</strong></p>
<ul>
<li><p>sender 和 receiver 关系</p>
</li>
<li><p>用于信息同步</p>
<ul>
<li>sender 发送 notification message</li>
<li>receiver 接收 notification message</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-32"><a href="#-32" class="headerlink" title=""></a></h6><ul>
<li>session 的每个阶段由 proxy 在内部维护</li>
<li>Example  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from maro.communication import SessionMessage, SessionType</span><br><span class="line"></span><br><span class="line">task_message = SessionMessage(tag=&quot;sum&quot;,</span><br><span class="line">                              source=&quot;master&quot;,</span><br><span class="line">                              destination=&quot;worker_001&quot;,</span><br><span class="line">                              body=[0, 1, 2, ...],</span><br><span class="line">                              session_type=SessionType.TASK)</span><br><span class="line"></span><br><span class="line">notification_message = SessionMessage(tag=&quot;check_out&quot;,</span><br><span class="line">                                      source=&quot;worker_001&quot;,</span><br><span class="line">                                      destination=&quot;master&quot;,</span><br><span class="line">                                      body=&quot;&quot;,</span><br><span class="line">                                      session_type=SessionType.NOTIFICATION)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="-33"><a href="#-33" class="headerlink" title=""></a></h6><ul>
<li><h5 id="MARO-通信原语实际接口"><a href="#MARO-通信原语实际接口" class="headerlink" title="MARO 通信原语实际接口"></a>MARO 通信原语实际接口</h5><ul>
<li>receive：用于持续接收消息<br>  receive_by_id：仅接收具有给定 session ID 的消息</li>
<li>send：单播，这是一种阻塞、一对一的发送模式，监视并收集来自远程对等方的回复消息   </li>
<li>isend：非阻塞版的 send ，将立即返回 message session ID，该 ID 可由  receive_by_id 使用</li>
<li>scatter：send 的高级版本，用于向 peer 发送消息，并监视和收集来自 peer 的回复消息，不是真正的多播，每条消息都会经过完整的 TCP&#x2F;IP 堆栈（ZeroMQ driver），如果要发送的消息完全相同，并且想要更好的性能，请改用 broadcast 接口</li>
<li>iscatter：非阻塞版本的 scatter ，message session ID 将立即返回，可由 receive_by_id 使用</li>
<li>broadcast：阻塞，用于向所有订阅者广播消息，将监视并收集所有订阅者的回复消息</li>
<li>ibroadcast：非阻塞版本的 broadcast ，相关 message session ID 将立即返回，可供 receive_by_id 使用</li>
</ul>
</li>
</ul>
<h6 id="-34"><a href="#-34" class="headerlink" title=""></a></h6><ul>
<li><h5 id="Conditional-Event-Register-Table"><a href="#Conditional-Event-Register-Table" class="headerlink" title="Conditional Event Register Table"></a>Conditional Event Register Table</h5><ul>
<li>提供消息自动发送机制</li>
<li>通过将 conditional event 和相关的 handler function 注册到注册表中，当 conditional event 满足时，handler function 将与接收到的消息一起自动执行</li>
</ul>
<h6 id="-35"><a href="#-35" class="headerlink" title=""></a></h6>  <img src="/pictures/maro-distributed-toolkit/register_table.register.svg"/>
  
<h6 id="-36"><a href="#-36" class="headerlink" title=""></a></h6><ul>
<li><p>conditional event 用于声明自动触发相关 handler function 所需的消息组</p>
</li>
<li><p>unit event 是条件事件中的最小组件，声明格式分三段</p>
<ul>
<li>source：用于声明所需的消息源</li>
<li>tag：消息实例的属性</li>
<li>amount：所需的消息实例量</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unit_event_abs = &quot;worker:update:10&quot;</span><br><span class="line"></span><br><span class="line">unit_event_rel = &quot;worker:update:60%&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AND OR 操作支持更复杂的业务逻辑</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">combined_event_and = (&quot;worker_01:update:2&quot;,</span><br><span class="line">                   &quot;worker_02:update:3&quot;,</span><br><span class="line">                   &quot;AND&quot;)</span><br><span class="line"></span><br><span class="line">combined_event_or = (&quot;worker_03:update:1&quot;,</span><br><span class="line">                      &quot;worker_04:update:5&quot;,</span><br><span class="line">                      &quot;OR&quot;)</span><br><span class="line"></span><br><span class="line">combined_event_mix = ((&quot;worker_01:update:2&quot;, &quot;worker_02:update:3&quot;, &quot;AND&quot;),</span><br><span class="line">                      &quot;worker_03:update:1&quot;,</span><br><span class="line">                      &quot;OR&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Handler function 是绑定到特定 conditional event 的用户定义的回调函数，当满足事件的条件时，相关消息将被发送到处理程序函数执行</p>
  <img src="/pictures/maro-distributed-toolkit/register_table.trigger.svg"/>

  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># A common handler function signature</span><br><span class="line">def handler(that, proxy, messages):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">        Conditional event handler function.</span><br><span class="line"></span><br><span class="line">        Args:</span><br><span class="line">            that: local instance reference, which needs to be operated.</span><br><span class="line">            proxy: the proxy reference for remote communication.</span><br><span class="line">            messages: received messages.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="-37"><a href="#-37" class="headerlink" title=""></a></h6><ul>
<li><h5 id="Distributed-Decorator"><a href="#Distributed-Decorator" class="headerlink" title="Distributed Decorator"></a>Distributed Decorator</h5><ul>
<li><p>从本地函数类生成分布式 worker 类的帮助程序</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from maro.communication import dist, Proxy</span><br><span class="line"></span><br><span class="line"># Initialize proxy instance for remote communication.</span><br><span class="line">proxy = Proxy(group_name=&quot;master-worker&quot;,</span><br><span class="line">              component_type=&quot;worker&quot;,</span><br><span class="line">              expected_peers=[(&quot;master&quot;, 1)])</span><br><span class="line"></span><br><span class="line"># Declare the trigger condition of rollout event.</span><br><span class="line">rollout_event = &quot;master:rollout:1&quot;</span><br><span class="line"></span><br><span class="line"># Implement rollout event handler logic.</span><br><span class="line">def on_rollout(that, proxy, messages):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"># Assemble event-handler directory.</span><br><span class="line">handler_dict = &#123;rollout_event: on_rollout&#125;</span><br><span class="line"></span><br><span class="line"># Convert a local functional class to a distributed one.</span><br><span class="line">@dist(proxy, handler_dict)</span><br><span class="line">class Worker:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/10/29/VIM-%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/29/VIM-%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">VIM 配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-10-29 14:31:55 / Modified: 15:19:56" itemprop="dateCreated datePublished" datetime="2022-10-29T14:31:55+08:00">2022-10-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="VIM-配置说明"><a href="#VIM-配置说明" class="headerlink" title="VIM 配置说明"></a>VIM 配置说明</h3><ol>
<li><p>安装 neovim 可以直接从 github 下载 appimage</p>
</li>
<li><p>配置 neovim 首次启动使用 :checkhealth 查看配置的路径等信息</p>
</li>
<li><p>coc.nvim 的 LSP 服务需要 npm （ node.js ）提供支持，npm 安装的时候可以从官方网站那里下载然后安装到指定 path，之后的 -g 安装 npm 包的时候包会安装在安装 npm 的目录下面</p>
</li>
<li><p>注意这个 coc-setting.json 这个在安装了 coc.nvim 之后可以 :CocConfig 来进行编辑，json 里面这一句话一定要加上，解决了初次 tab 选中的问题</p>
</li>
<li><p>配置文件 init.vim 位于 &#x2F;home&#x2F;asleep&#x2F;.config&#x2F;nvim 下，coc-settings.json 也是在这个路径下面</p>
</li>
<li><p>vimplug 管理插件，这里有点特殊，这里我将其他插件安装在与 vimplug 的 plug.vim 同一个目录下面，即  &#x2F;home&#x2F;asleep&#x2F;.local&#x2F;share&#x2F;nvim&#x2F;site&#x2F;autoload</p>
</li>
<li><p>安装各种插件之前，应该要了解各个插件的依赖</p>
</li>
<li><p>至于 vimplug 的安装，只需要把 github 上面的那个 plug.vim 文件弄下来放在上面说的那个 path 下面就可以调用 :PlugInstall，不用整个仓库弄下来</p>
</li>
<li><p>至于 coc 的插件，coc.nvim 是一个插件管理器，coc.nvim 管理的插件在 &#x2F;home&#x2F;asleep&#x2F;.config&#x2F;coc&#x2F;extensions 下面</p>
</li>
<li><p>综上所述，如果要迁移 nvim 及其配置，只需要复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/home/asleep/.config/coc/extensions   “coc-extensions”</span><br><span class="line"></span><br><span class="line">/home/asleep/.config/nvim   “coc-settings.json”  “init.vim“</span><br><span class="line"></span><br><span class="line">/home/asleep/.local/share/nvim/site/autoload   “plug.vim” “vim-plug extensions”</span><br></pre></td></tr></table></figure>
</li>
<li><p>这三个路径下的文件就可以完成迁移 </p>
</li>
<li><p>每次修改 init.vim 之后，都要 :so % 即 :source init.vim 生效</p>
</li>
</ol>
<h6 id=""><a href="#" class="headerlink" title=""></a></h6><h3 id="coc-setting-json"><a href="#coc-setting-json" class="headerlink" title="coc-setting.json"></a>coc-setting.json</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;suggest.noselect&quot;: true,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><h3 id="init-vim-已启用的配置"><a href="#init-vim-已启用的配置" class="headerlink" title="init.vim 已启用的配置"></a>init.vim 已启用的配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">&quot; -------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot; ---------------------------------------------common-start----------------------------------------------------</span><br><span class="line">&quot; -------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">set number</span><br><span class="line">set mouse=c</span><br><span class="line">set tabstop=4</span><br><span class="line">set autoindent</span><br><span class="line">set backspace=indent,eol,start</span><br><span class="line">set hlsearch</span><br><span class="line">set clipboard+=unnamedplus</span><br><span class="line">set foldmethod=syntax</span><br><span class="line">set nofoldenable</span><br><span class="line">&quot; 自动同步</span><br><span class="line">set autoread</span><br><span class="line">set fillchars=eob:\ </span><br><span class="line"></span><br><span class="line">&quot; Vim jump to the last position when reopening a file</span><br><span class="line">if has(&quot;autocmd&quot;)</span><br><span class="line">  au BufReadPost * if line(&quot;&#x27;\&quot;&quot;) &gt; 1 &amp;&amp; line(&quot;&#x27;\&quot;&quot;) &lt;= line(&quot;$&quot;) | exe &quot;normal! g&#x27;\&quot;&quot; | endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function! ESC_IMAP()</span><br><span class="line">    let l:frontChar = getline(&#x27;.&#x27;)[col(&#x27;.&#x27;) - 2]</span><br><span class="line">    if l:frontChar == &quot;;&quot; </span><br><span class="line">        call feedkeys(&quot;\&lt;BS&gt;\&lt;BS&gt;\&lt;ESC&gt;&quot;, &#x27;n&#x27;)</span><br><span class="line">    else</span><br><span class="line">        call feedkeys(&quot;\&lt;BS&gt;\;&quot;, &#x27;n&#x27;)</span><br><span class="line">    endif</span><br><span class="line">endfunction</span><br><span class="line">inoremap &lt;expr&gt; ; ESC_IMAP()</span><br><span class="line"></span><br><span class="line">set timeoutlen=200</span><br><span class="line"></span><br><span class="line">nnoremap ;; &lt;ESC&gt;</span><br><span class="line">vnoremap ;; &lt;ESC&gt;</span><br><span class="line">snoremap ;; &lt;ESC&gt;</span><br><span class="line">xnoremap ;; &lt;ESC&gt;</span><br><span class="line">cnoremap ;; &lt;ESC&gt;</span><br><span class="line">onoremap ;; &lt;ESC&gt;</span><br><span class="line"></span><br><span class="line">&quot; exit windows</span><br><span class="line">tnoremap ;; &lt;C-\&gt;&lt;C-n&gt;</span><br><span class="line"></span><br><span class="line">&quot; switch windows</span><br><span class="line">nnoremap &lt;TAB&gt; &lt;C-w&gt;w</span><br><span class="line">nnoremap vv &lt;C-v&gt;</span><br><span class="line"></span><br><span class="line">echo expand(&quot;%:p:h&quot;)</span><br><span class="line"></span><br><span class="line">cnoreabbrev fd echo expand(&quot;%:p:h&quot;)</span><br><span class="line">cnoreabbrev vst vs&lt;ENTER&gt;:term</span><br><span class="line">cnoreabbrev spt sp&lt;ENTER&gt;:term</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot; -------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;-----------------------------------------------common-end----------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;</span><br><span class="line">&quot;</span><br><span class="line">&quot;</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;--------------------------------------------vim-plug-start---------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">call plug#begin(&#x27;/home/asleep/.local/share/nvim/site/autoload&#x27;)</span><br><span class="line">Plug &#x27;itchyny/lightline.vim&#x27;</span><br><span class="line">Plug &#x27;joshdick/onedark.vim&#x27;</span><br><span class="line">Plug &#x27;neoclide/coc.nvim&#x27;, &#123;&#x27;branch&#x27;: &#x27;release&#x27;&#125;</span><br><span class="line">Plug &#x27;jiangmiao/auto-pairs&#x27;</span><br><span class="line">Plug &#x27;ms-jpq/chadtree&#x27;, &#123;&#x27;branch&#x27;: &#x27;chad&#x27;, &#x27;do&#x27;: &#x27;python3 -m chadtree deps&#x27;&#125;</span><br><span class="line">Plug &#x27;sheerun/vim-polyglot&#x27;</span><br><span class="line">Plug &#x27;Yggdroot/LeaderF&#x27;, &#123; &#x27;do&#x27;: &#x27;:LeaderfInstallCExtension&#x27; &#125;</span><br><span class="line">Plug &#x27;tpope/vim-fugitive&#x27;</span><br><span class="line">Plug &#x27;sbdchd/neoformat&#x27;</span><br><span class="line">Plug &#x27;iamcco/markdown-preview.nvim&#x27;, &#123; &#x27;do&#x27;: &#x27;cd app &amp;&amp; yarn install&#x27; &#125;</span><br><span class="line">call plug#end()</span><br><span class="line"></span><br><span class="line">&quot;有些插件需要安装 nerd fonts！</span><br><span class="line">&quot;nerd fonts 包括了 powerline fonts！</span><br><span class="line">&quot;建议安装 DejaVuSansMonoNerd！</span><br><span class="line"></span><br><span class="line">&quot;这个是 LeaderF 的设置</span><br><span class="line">let g:Lf_WindowPosition = &#x27;popup&#x27;</span><br><span class="line">cnoreabbrev ff LeaderfFile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cnoreabbrev fm Neoformat</span><br><span class="line"></span><br><span class="line">cnoreabbrev mt MarkdownPreviewToggle</span><br><span class="line">let g:mkdp_theme = &quot;light&quot;</span><br><span class="line"></span><br><span class="line">&quot;这个是 chadtree 的设置</span><br><span class="line">&quot;明确指定绑定的键之后，就不会使用默认的键</span><br><span class="line">let g:chadtree_settings = &#123;</span><br><span class="line">  \ &#x27;keymap.change_focus_up&#x27;: [&quot;..&quot;],</span><br><span class="line">  \ &#x27;keymap.secondary&#x27;: [&quot;&lt;2-leftmouse&gt;&quot;]</span><br><span class="line">\&#125;</span><br><span class="line"></span><br><span class="line">nnoremap &lt;F2&gt; :CHADopen&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">let g:onedark_terminal_italics=1</span><br><span class="line">autocmd ColorScheme * highlight Normal ctermbg=NONE guibg=NONE </span><br><span class="line">colorscheme onedark</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let g:lightline = &#123;</span><br><span class="line">      \&#x27;colorscheme&#x27; : &#x27;onedark&#x27;,</span><br><span class="line">      \ &#x27;separator&#x27;: &#123; &#x27;left&#x27;: &#x27;&#x27;, &#x27;right&#x27;: &#x27;&#x27; &#125;,</span><br><span class="line">      \ &#x27;subseparator&#x27;: &#123; &#x27;left&#x27;: &#x27;&#x27;, &#x27;right&#x27;: &#x27;&#x27; &#125;,</span><br><span class="line">      \ &#x27;component&#x27;: &#123;</span><br><span class="line">            \ &#x27;lineinfo&#x27;: &#x27; %3l / %L : %-2v&#x27;,</span><br><span class="line">            \ &#125;, </span><br><span class="line">      \ &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;-----------------------------------------------vim-plug-end--------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;------------------------------------------------coc-start----------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">inoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt; coc#pum#visible() ? coc#pum#next(1) :&quot;\&lt;Tab&gt;&quot; </span><br><span class="line"></span><br><span class="line">nnoremap gd &lt;Plug&gt;(coc-definition)</span><br><span class="line">nnoremap gt &lt;Plug&gt;(coc-type-definition)</span><br><span class="line">nnoremap gi &lt;Plug&gt;(coc-implementation)</span><br><span class="line">nnoremap gr &lt;Plug&gt;(coc-references)</span><br><span class="line"></span><br><span class="line">&quot; Use K to show documentation in preview window.</span><br><span class="line">function! ShowDocumentation()</span><br><span class="line">  if CocAction(&#x27;hasProvider&#x27;, &#x27;hover&#x27;)</span><br><span class="line">    call CocActionAsync(&#x27;doHover&#x27;)</span><br><span class="line">  else</span><br><span class="line">    call feedkeys(&#x27;K&#x27;, &#x27;in&#x27;)</span><br><span class="line">  endif</span><br><span class="line">endfunction</span><br><span class="line">nnoremap &lt;silent&gt; K :call ShowDocumentation()&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">&quot; Highlight the symbol and its references when holding the cursor.</span><br><span class="line">autocmd CursorHold * silent call CocActionAsync(&#x27;highlight&#x27;)</span><br><span class="line"></span><br><span class="line">&quot; Symbol renaming.</span><br><span class="line">nnoremap &lt;space&gt;r &lt;Plug&gt;(coc-rename)</span><br><span class="line"></span><br><span class="line">&quot; Show all diagnostics.</span><br><span class="line">nnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;a  :&lt;C-u&gt;CocList diagnostics&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">&quot; Manage extensions.</span><br><span class="line">nnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;e  :&lt;C-u&gt;CocList extensions&lt;cr&gt;</span><br><span class="line"></span><br><span class="line">&quot; Find symbol of current document.</span><br><span class="line">nnoremap &lt;silent&gt;&lt;nowait&gt; &lt;space&gt;o  :&lt;C-u&gt;CocList outline&lt;cr&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------coc-end-----------------------------------------------------</span><br><span class="line">&quot;-------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><h3 id="init-vim-未启用的配置"><a href="#init-vim-未启用的配置" class="headerlink" title="init.vim 未启用的配置"></a>init.vim 未启用的配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;&quot;----------------------------------------------netrw_start----------------------------------------------------</span><br><span class="line">&quot;&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;let g:netrw_banner = 0</span><br><span class="line">&quot;&quot;let g:netrw_liststyle = 3</span><br><span class="line">&quot;&quot;let g:netrw_browse_split = 4</span><br><span class="line">&quot;&quot;let g:netrw_altv = 1</span><br><span class="line">&quot;&quot;let g:netrw_winsize = 15</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;set autochdir</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;&quot; Toggle Vexplore with &lt;F2&gt;</span><br><span class="line">&quot;&quot;function! ToggleVExplorer()</span><br><span class="line">&quot;&quot;    if exists(&quot;t:expl_buf_num&quot;)</span><br><span class="line">&quot;&quot;        let expl_win_num = bufwinnr(t:expl_buf_num)</span><br><span class="line">&quot;&quot;        let cur_win_num = winnr()</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;        if expl_win_num != -1</span><br><span class="line">&quot;&quot;            while expl_win_num != cur_win_num</span><br><span class="line">&quot;&quot;                exec &quot;wincmd w&quot;</span><br><span class="line">&quot;&quot;                let cur_win_num = winnr()</span><br><span class="line">&quot;&quot;            endwhile</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;            close</span><br><span class="line">&quot;&quot;        endif</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;        unlet t:expl_buf_num</span><br><span class="line">&quot;&quot;    else</span><br><span class="line">&quot;&quot;         Vexplore</span><br><span class="line">&quot;&quot;         let t:expl_buf_num = bufnr(&quot;%&quot;)</span><br><span class="line">&quot;&quot;    endif</span><br><span class="line">&quot;&quot;endfunction</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;map &lt;F2&gt; :call ToggleVExplorer()&lt;CR&gt;</span><br><span class="line">&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot; 状态栏无插件设置</span><br><span class="line">&quot;&quot;hi VertSplit ctermfg=NONE ctermbg=NONE cterm=NONE</span><br><span class="line">&quot;&quot;set fillchars=vert:\ </span><br><span class="line">&quot;&quot;&quot;&quot;set fillchars=vert:\│</span><br><span class="line">&quot;&quot;set statusline=%*\ %.50F\               &quot;显示文件名和文件路径</span><br><span class="line">&quot;&quot;set statusline+=%=%y%m%r%h%w\ %*        &quot;显示文件类型及文件状态</span><br><span class="line">&quot;&quot;set statusline+=%&#123;&amp;ff&#125;\[%&#123;&amp;fenc&#125;]\ %*   &quot;显示文件编码类型</span><br><span class="line">&quot;&quot;set statusline+=%l/%L,%c\ %*            &quot;显示光标所在行和列</span><br><span class="line">&quot;&quot;set statusline+=%3p%%                   &quot;显示光标前文本所占总文本的比例</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;</span><br><span class="line">&quot;&quot;hi Statusline ctermfg=NONE ctermbg=NONE cterm=bold </span><br><span class="line">&quot;&quot;hi StatuslineNC ctermfg=NONE ctermbg=NONE cterm=NONE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;-------------------------------------------------------------------------------------------------------------</span><br><span class="line">&quot;&quot;-----------------------------------------------netrw-end-----------------------------------------------------</span><br><span class="line">&quot;&quot;-------------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://hcy-asleep.github.com/2022/10/27/MARO-VM-%E8%B0%83%E5%BA%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HCY">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Coder's Pocket">
      <meta itemprop="description" content="A Space Belongs To HCY">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | A Coder's Pocket">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/27/MARO-VM-%E8%B0%83%E5%BA%A6/" class="post-title-link" itemprop="url">MARO VM 调度</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-27 11:01:57" itemprop="dateCreated datePublished" datetime="2022-10-27T11:01:57+08:00">2022-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-10-28 18:19:07" itemprop="dateModified" datetime="2022-10-28T18:19:07+08:00">2022-10-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li>在云服务期间，用户请求具有一定数量资源的 <strong>虚拟机（VM）（Virtual Mechine）</strong>，例如中央处理器、内存等</li>
<li>假设一个特定的时间，VM 请求的数量和到达模式是固定的，给定一个物理资源有限的 <strong>物理机（PM）（Physical Mechine）</strong> 集群</li>
<li>不同的 VM 分配策略导致数据中心的成功完成量不同，运营成本也不同</li>
<li>对于云提供商，一个好的 VM 分配策略可以最大限度地提高资源利用率，从而可以通过向用户提供更多的 VM 来增加利润</li>
<li>对于云用户，良好的 VM 分配策略可以最大程度地缩短 VM 响应时间，并提供更好的使用体验</li>
</ul>
<h6 id=""><a href="#" class="headerlink" title=""></a></h6><h3 id="资源供需"><a href="#资源供需" class="headerlink" title="资源供需"></a>资源供需</h3><img src="/pictures/maro-vm-调度/2022.10.27.20.00.43.png"/>

<ul>
<li><p>每个 <strong>PM</strong> 中的物理资源是中心资源，包括 <strong>物理内核</strong> 和 <strong>内存</strong></p>
<ul>
<li>VM 请求需要一定数量的 <strong>物理资源</strong> ，资源要求因不同的 VM 请求而异 </li>
<li>只要指定的 PM 的剩余资源足够，<strong>模拟器</strong> 就会将 VM 分配到指定 PM ，VM 会在指定 PM 中创建 </li>
<li>VM 的资源利用率动态变化，PM 的实时能耗将在 <strong>Runtime-Simulation（模拟器）</strong> 中被模拟出来</li>
<li>VM 执行一段时间后完成其任务，<strong>模拟器</strong> 将释放分配给此 VM 的资源，并从 PM 中解除分配此 VM ，物理资源被释放，可以处理下一个 VM 请求</li>
</ul>
</li>
</ul>
<img src="/pictures/maro-vm-调度/2022.10.28.15.14.52.png"/>


<h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><h3 id="VM-Request"><a href="#VM-Request" class="headerlink" title="VM Request"></a>VM Request</h3><ul>
<li>MARO 和机器学习算法原理类似，需要 <strong>样本数据</strong> 训练出 <strong>模型（找出当前场景的规律）</strong>，再通过模型去 <strong>预测</strong> 怎样的行为更加正确符合实际</li>
<li>VM scheduling 场景里面，<strong>样本数据</strong> 是 VM Request<strong>s</strong> ，样本数据从实际工作负荷中统一采样</li>
<li>只要原始数据集足够大，采样率不太小，采样的 VM Requests<strong>（复数名词）</strong> 就可以被认为遵循与原始请求类似的分布</li>
<li>一个 VM Request 包含 <strong>VM 信息</strong>（如 订阅 ID、部署 ID 和 VM 类别）、<strong>VM 的所需资源</strong>（包括所需的 CPU 核心数和内存）以及 <strong>剩余缓冲时间（remaining buffer time）</strong></li>
</ul>
<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><h3 id="VM-类型"><a href="#VM-类型" class="headerlink" title="VM 类型"></a>VM 类型</h3><ul>
<li><p>交互式</p>
<ul>
<li>交互式 VM 通常需要较低的响应时间，因此设置此类 VM 只能分配给不可超额订阅的 PM 服务器</li>
</ul>
</li>
</ul>
<h6 id="-3"><a href="#-3" class="headerlink" title=""></a></h6><ul>
<li><p>延迟不敏感</p>
<ul>
<li>不区分延迟的 VM 通常用于批处理任务或开发工作负荷，可以将此类 VM 分配给可过度订阅的 PM 服务器</li>
</ul>
</li>
</ul>
<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><h3 id="VM-分配"><a href="#VM-分配" class="headerlink" title="VM 分配"></a>VM 分配</h3><ul>
<li><p>根据 <strong>有效的 PM 列表</strong> ，<strong>模拟器记录的历史信息</strong> 以及 <strong>VM 的详细所需资源</strong> ，<strong>VM 调度器（决策代理）</strong> 将根据其分配策略做出决策</p>
</li>
<li><p>两种有意义的操作</p>
<ul>
<li>将 <strong>有效的 PM ID</strong> 传送到模拟器</li>
<li>推迟如果 <strong>剩余缓冲区时间</strong> 足够，则可以稍后将处理的 VM Request</li>
</ul>
</li>
</ul>
<h6 id="-5"><a href="#-5" class="headerlink" title=""></a></h6><h3 id="Oversubscription-超额订阅"><a href="#Oversubscription-超额订阅" class="headerlink" title="Oversubscription 超额订阅"></a>Oversubscription 超额订阅</h3><ul>
<li><p>考虑到各种服务级别，将物理机分为可超额订阅和非超额订阅的</p>
</li>
<li><p>所谓超额，就比如 10 个 VM 实际上只使用 7 个 PM （就是厂商为了省钱）</p>
</li>
<li><p>对于超额订阅，可以在 <strong>config.yml</strong> 中设置参数</p>
</li>
<li><p>在此场景，有两个资源可能被超额订阅，CPU 和 内存，因可以设置这两个的最大超额订阅率</p>
<ul>
<li><p><strong>MAX_CPU_OVERSUBSCRIPTION_RATE</strong> ，CPU 的超额订阅率，默认设置为 1.15 ，意味着每个 PM 最多可以分配其资源容量的 1.15 倍 </p>
</li>
<li><p><strong>MAX_MEM_OVERSUBSCRIPTION_RATE</strong> ，内存的超额订阅率，与 CPU 的类似</p>
</li>
</ul>
</li>
<li><p>为了保护 PM 免受过载的影响，需要考虑 CPU 利用率 ，MAX_UTILIZATION_RATE 被用作安全机制</p>
<ul>
<li><strong>MAX_UTILIZATION_RATE</strong> ，默认设置为 1，这意味着在筛选有效 PM 时，允许的最大物理 CPU 使用率为 100%</li>
</ul>
</li>
</ul>
<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><h3 id="Runtime-Simulation"><a href="#Runtime-Simulation" class="headerlink" title="Runtime Simulation"></a>Runtime Simulation</h3><ul>
<li><h4 id="动态利用率"><a href="#动态利用率" class="headerlink" title="动态利用率"></a>动态利用率</h4><ul>
<li>为了使模拟环境最接近真实情况，MARO 模拟每个 VM 的资源利用率（当前仅为 CPU 利用率）</li>
<li><strong>模拟的</strong> VM CPU 利用率根据<strong>实际的</strong> VM 工作负载读数而变化</li>
<li>MARO 还将根据每个 PM 中的<strong>实时</strong> VM 定期更新<strong>实时</strong>资源利用率</li>
</ul>
</li>
<li><h4 id="实时能耗"><a href="#实时能耗" class="headerlink" title="实时能耗"></a>实时能耗</h4><ul>
<li><p>不同的 VM 分配会导致 PM 集群的能耗不同，MARO 还根据 CPU 利用率模拟（计算）能耗</p>
<ul>
<li><p>能耗曲线</p>
<ul>
<li>这个非线性曲线反映了 CPU 利用率 与 能耗 的关系，用于模拟（计算）能耗</li>
</ul>
</li>
</ul>
</li>
</ul>
  <img src="/pictures/maro-vm-调度/vm.energy_curve.svg"/></li>
</ul>
<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><h3 id="Overload"><a href="#Overload" class="headerlink" title="Overload"></a>Overload</h3><ul>
<li><p>由于 VM 的 CPU 使用率随时间而变化，因此在启用超额订阅时，VM 的 CPU 使用率之和可能会超过物理资源的容量，这种情况称为过载</p>
<ul>
<li><p>目前对于过载的情况，MARO 只支持<strong>静默（杀死）所有虚拟机</strong> 或 <strong>仅记录过载时间</strong>，在 config.yml 里面设置</p>
<ul>
<li><p><strong>KILL_ALL_VMS_IF_OVERLOAD</strong> </p>
<ul>
<li>如果启用此操作，则一旦发生重载，将解除分配位于重载 PM 的<strong>所有</strong> VM</li>
<li>考虑到过载的影响，MARO 仍然会计算高利用率的能耗，静默行动对 PM 利用率的影响将反映在下一次 tick 中</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><ul>
<li>无论是否启用终止所有 VM，过载 PM 的数量和过载 VM 的数量都会被计算</li>
<li>这两个指标是累积值，将被记录为环境指标</li>
</ul>
<h6 id="-9"><a href="#-9" class="headerlink" title=""></a></h6><h3 id="VM-解除分配"><a href="#VM-解除分配" class="headerlink" title="VM 解除分配"></a>VM 解除分配</h3><ul>
<li>MARO 模拟器会定期检查每次 tick 中完成任务的虚拟机</li>
<li>完成的 VM 意味着它经历了一个完整的生命周期，已准备好终止，它所占用的资源最终将再次可用</li>
<li>然后，模拟器将释放已完成的 VM 的资源，并最终从 PM 中删除 VM</li>
</ul>
<h6 id="-10"><a href="#-10" class="headerlink" title=""></a></h6><h3 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h3><ul>
<li><p>准备两个 csv 文件 vm_table 和 cpu_readings_file</p>
<ul>
<li><p>vm_table</p>
<ul>
<li><p><strong>vm_id</strong>:       int, 每个 vm 的id</p>
</li>
<li><p><strong>sub_id</strong>:      int, subscription id（每个 vm 的订阅 id）</p>
</li>
<li><p><strong>deploy_id</strong>:   int, 每个 vm 的部署 id</p>
</li>
<li><p><strong>timestamp</strong>:   int, 每个 vm 的创建时间</p>
</li>
<li><p><strong>vm_deleted</strong>:  int. 每个 vm 的删除时间</p>
</li>
<li><p><strong>vm_lifetime</strong>: int, 每个 vm 的生存时间，Lifetime &#x3D; deletion time - creation time (timestamp) + 1</p>
</li>
<li><p><strong>vm_category</strong>: int, 目前有三种类型</p>
<ul>
<li><p>Delay-Insensitive</p>
<ul>
<li>可能延迟的 VM 工作负荷，例如批处理任务或测试工作负荷</li>
<li>可以将此类 VM 分配给可过度订阅的 PM</li>
</ul>
</li>
<li><p>Interactive</p>
<ul>
<li>交互式 VM 工作负荷，需要用户及时响应</li>
<li>此类 VM 只能分配给不可超额订阅的 PM</li>
</ul>
</li>
<li><p>Unknown</p>
<ul>
<li>未知类型</li>
<li>为避免过载，此类 VM 被视为交互式 VM，只能分配给不可超额订阅的 PM</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>cpu_readings_file </p>
<ul>
<li><strong>timestamp</strong>:   int, 与 vm_table 中的 timestamp 匹配</li>
<li><strong>vm_id</strong>: int, 与 vm_table 中的 vm_id 匹配</li>
<li><strong>cpu_utilization</strong>: float, VM CPU 的利用率，以百分比单位 （%）存储</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-11"><a href="#-11" class="headerlink" title=""></a></h6><h3 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h3><ul>
<li><p>将 CSV 数据集构建为 MARO 模拟器可以使用的二进制文件</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># maro data build --meta $PATH_TO_META_FILE --file $PATH_TO_CSV_FILE  --output $PATH_TO_OUTPUT_FILE</span><br><span class="line">maro data build --meta ~/.maro/data/vm_scheduling/meta/vmtable.yml  --file ~/.maro/data/vm_scheduling/.build/azure.2019.10k/vmtable.bin --output $PWD/vmtable.bin</span><br></pre></td></tr></table></figure>
<ul>
<li><p>–meta：必需，用于指定 meta file 的路径。默认情况下，meta file 位于</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/.maro/data/vm_scheduling/meta/</span><br></pre></td></tr></table></figure></li>
<li><p>–file：必需，用于指定源 CSV 数据文件的路径，如果需要多个源 CSV 数据文件，则可以在特定文件中列出源文件的所有完整路径，并使用 @ 符号指定这个特定文件</p>
</li>
<li><p>–output：必需，用于指定目标二进制文件的路径</p>
</li>
</ul>
</li>
<li><p>生成二进制文件之后，在 topologies 目录下的 config.yml 中指定 VM_TABLE 和 CPU_READINGS 的直接路径</p>
</li>
</ul>
<h6 id="-12"><a href="#-12" class="headerlink" title=""></a></h6><h3 id="Environment-Interface"><a href="#Environment-Interface" class="headerlink" title="Environment Interface"></a>Environment Interface</h3><ul>
<li><h4 id="DecisionPayload"><a href="#DecisionPayload" class="headerlink" title="DecisionPayload"></a>DecisionPayload</h4><ul>
<li><p>一旦环境需要代理的响应来促进模拟，它就会抛出一个带有 DecisionPayload 的 PendingDecision 事件</p>
</li>
<li><p>DecisionPayload 包含以下信息</p>
<ul>
<li><strong>valid_pms (List[int])</strong> ：被视为有效的 PM ID 列表（其 CPU 和内存资源足以满足传入的 VM 请求） </li>
<li><strong>vm_id (int)</strong> ：传入的 VM Request（正在等待分配的 VM Request）的 vm_id ，</li>
<li><strong>vm_cpu_cores_requirement (int)</strong> ：传入的 VM Request 的 CPU 内核数量</li>
<li><strong>vm_memory_requirement (int)</strong> ：传入的 VM Request 请求的内存资源大小</li>
<li><strong>remaining_buffer_time（int）</strong> ：当使用 remaining_buffer_time 时，VM Request 将被视为失败，可以在 config.yml 里面设置</li>
</ul>
</li>
</ul>
</li>
<li><h4 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h4><ul>
<li><p>从环境中获取 PendingDecisionAction 事件后，代理应使用 Action 进行响应，以下是有效的 Action</p>
<ul>
<li><p><strong>None</strong>：除了忽略此 VM Request 之外什么都不执行</p>
</li>
<li><p><strong>AllocateAction</strong>：VM 的创建时间将固定在它收到这个 Request 的 tick 处，模拟器将更新目标 PM 的工作负载（CPU 核心数量，内存和能耗），这个 Action 包括:</p>
<ul>
<li>**vm_id(int)**：等待分配资源的 VM 的 ID</li>
<li>**pm_id(int)**：计划将 VM 分配到的 PM 的 ID</li>
</ul>
</li>
<li><p><strong>PostponeAction</strong>：计算 remaining buffer time，这个 Action 包括：</p>
<ul>
<li><strong>vm_id (int)</strong> ：等待分配的 VM 的 ID</li>
<li><strong>postpone_step（int）</strong>：分配要推迟的次数，单位是 DELAY_DURATION ，1 表示延迟 1 DELAY_DURATION ，可以在 config.yml 中设置</li>
<li>如果时间仍然足够，模拟器将重新生成一个新的请求事件，新需求事件的 仅在剩余缓冲时间上与旧事件不同</li>
<li>如果时间用完，模拟器会将其记录为失败的分配</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="-13"><a href="#-13" class="headerlink" title=""></a></h6><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line"></span><br><span class="line">from maro.simulator import Env</span><br><span class="line">from maro.simulator.scenarios.vm_scheduling import AllocateAction, DecisionPayload, PostponeAction</span><br><span class="line"></span><br><span class="line"># Initialize an Env for vm_scheduling scenario</span><br><span class="line"># 初始化环境</span><br><span class="line">env = Env(</span><br><span class="line">  scenario=&quot;vm_scheduling&quot;,     </span><br><span class="line">  topology=&quot;azure.2019.10k&quot;,    </span><br><span class="line">  start_tick=0,                </span><br><span class="line">  durations=8638,              </span><br><span class="line">  snapshot_resolution=1</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 初始化变量，声明类型，&quot;:&quot;用于声明类型</span><br><span class="line">metrics: object = None</span><br><span class="line">decision_event: DecisionPayload = None</span><br><span class="line">is_done: bool = False</span><br><span class="line">action: AllocateAction = None</span><br><span class="line"></span><br><span class="line"># Start the env with a None Action</span><br><span class="line"># 开始模拟</span><br><span class="line">metrics, decision_event, is_done = env.step(None)</span><br><span class="line"></span><br><span class="line">while not is_done:</span><br><span class="line">    valid_pm_num: int = len(decision_event.valid_pms)</span><br><span class="line">	# 作出决策</span><br><span class="line">    if valid_pm_num &lt;= 0:</span><br><span class="line">        # No valid PM now, postpone.</span><br><span class="line">		# 没有可用的 PM ，推迟分配</span><br><span class="line">        action: PostponeAction = PostponeAction(</span><br><span class="line">            vm_id=decision_event.vm_id,</span><br><span class="line">            postpone_step=1</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        # Randomly choose an available PM.</span><br><span class="line">		# 有可用的 PM ，随机选一个 PM 与 VM 绑定</span><br><span class="line">        random_idx = random.randint(0, valid_pm_num - 1)</span><br><span class="line">        pm_id = decision_event.valid_pms[random_idx]</span><br><span class="line">        action: AllocateAction = AllocateAction(</span><br><span class="line">            vm_id=decision_event.vm_id,</span><br><span class="line">            pm_id=pm_id</span><br><span class="line">        )</span><br><span class="line">	</span><br><span class="line">	# 采取行动</span><br><span class="line">    metrics, decision_event, is_done = env.step(action)</span><br><span class="line"></span><br><span class="line">print(f&quot;[Random] Topology: azure.2019.10k. Total ticks: 8638. Start tick: 0&quot;)</span><br><span class="line">print(metrics)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HCY</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
